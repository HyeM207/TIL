# Logstash
책 '엘라스틱 스택 개발부터 운영까지 - 김준영/정상운 지음'을 공부하며 정리하였습니다.  

</br>

# 1. Logstash
플러그인 기반의 오픈소스 데이터 처리 파이프라인 도구  
- `플러그인 기반`
    - Logstash의 파이프라인의 각 요소 모두 플러그인 형태로 만들어져있고, 기본 플러그인 외에도 많은 커뮤니티 플러그인들이 있음
- `모든 형태의 데이터처리` 
    - 기본 플러그인 만으로도 데이터 소스에서 구조화/비구조화 데이터 입력받아 가공 후 저장 가능함 
    - 특히 시간에 따라 발생하는 데이터 처리에 최적화되어 있음
- 높은 성능
    - `자체 내장 메모리와 파일 기반의 큐`를 사용하여 처리 속도와 안정성이 높음
    - 인덱싱 도큐먼트 수와 용량을 종합적 고려해 벌크 인덱싱 수행하고, 파이프라인 배치 크기 조정을 통해 병목현상을 방지하고 성능 최적화 가능
- 안정성
    - Elasticsearch의 장애 상황에 대응하기 위해, 재시도 로직이나 오류가 발생한 도큐먼트를 따로 보관하는 `데드 레터 큐`를 내장함
    - 파일 기반 큐 사용시, Logstash 장애 상황에서 도큐먼트 유실 최소화 가능

</br></br>

# 2. 파이프라인
## 2.1 파이프라인
> 파이프라인 소개

Logstash의 가장 중요한 부분으로, 파이프라인은 데이터를 입력받아 실시간으로 변경하고 이를 다른 시스템에 전달하는 역할을 한다.  

구성요소는 크게 `입력`, `필터`, `출력` 세 가지로 구성된다. (입력과 출력은 필수, 필터는 선택)   
</br>

> 파이프라인 실행 순서
```
데이터 소스 → [ 입력 → 필터 → 출력 ] → Elasticsearch
            ↳ Logstash Pipeline ↲ 
```
- 입력 (필수) : 소스로부터 데이터를 받아들이는 모듈  
- 필터 (선택) : 입력으로 들어오는 데이터를 원하는 형태로 가공하는 모듈  
- 출력 (필수) : 데이터를 외부로 전달하는 모듈  

</br>

> Logstash 실행 방법과 예시

Logstash가 설치된 폴더의 bin 폴더에서 logstash.bat 실행하면 된다. 또한, Logstash를 실행하기 위해서는 반드시 파이프라인 설정이 필요하다.   
예시로 CMD에서 다음 명령을 입력하여 표준 입력으로 전달받은 메시지를 다시 표준 출력으로 표시하는 파이프라인 예시이다. 

```
.\bin\logstash.bat -e "input { stdin { } } output { stdout { } }"
```

<br>실행 후 'hello hyem'을 입력하면 다음과 같이 결과가 출력된다.
```
{
    "@version" => "1",
     "host" => "DESTOP-0000000",
    "message" => "hello hyem\r",
    "@timestamp" => 2023-01-04T23:39:11.242Z
}
```
- 로그 스태시는 `JSON 형태`로 데이터 출력함 
- @version과 @timestamp는 logstash가 만든 필드
- `@` 기호는 logstash에 의해 생성된 필드, 안 붙은 필드는 수집을 통해 얻어진 정보다
- 간단한 파이프라인의 경우 위처럼 콘솔로 직접 입력가능하지만, 작업 이력관리를 위해 `pipeline.yml`이나 `파이프라인 설정 파일`을 만들어 logstash를 동작하는 것이 좋다 


</br>

> 파이프라인 기본 템플릿
```
input{
        { 입력 플러그인 }
}

filter {
    { 필터 플러그인 }
}
output {
    { 출력 플러그인 }
}
```
파이프라인 구성요소인 입력, 필터, 출력의 내부에 플러그인 지정 가능하다.   
용도나 형태에 맞춰 이미 만들어진 많은 플러그인이 있어 필요한 기능의 플러그인을 검색하여 템플릿을 추가하면 된다.

</br></br>

## 2.2 입력
> 입력 파트

Logstash의 가장 앞부분에 위치하여, 소스 원본으로부터 데이터를 입력받는 단계이다.

Logstash 입력이 받아들일 수 있는 데이터 소스들은 파일, 웹, 데이터베이스, 스트림 등 다양하다.

<br>

> 입력 플러그인

Logstash는 다양한 형태의 데이터를 쉽게 처리하기 위해 다양한 입력 플러그인들이 존재한다.  
 전체 입력 플러그인은 [공식 문서](https://www.elastic.co/guide/en/logstash/8.6/input-plugins.html)에서 확인 가능하고, `file`, `syslog`, `kafka`, `jdbc`가 자주 사용하는 입력 플러그인이다. 

<br><br>

 
## 2.3 필터
> 소개

필터는 선택적인 구성요소로, 입력 플러그인이 받은 데이터를 의미있는 데이터로 구조화하는 역할을 한다.  
필터 역시 플러그인 형태이며, 다양한 필터 플러그인 형태가 존재한다. 전체 플러그인은 [공식 문서](https://www.elastic.co/guide/en/logstash/8.6/filter-plugins.html)에서 확인 가능하고, `grok`, `dissect`, `mutate`, `date`가 자주 사용되는 필터 플러그인이다. 

<br><br>

 
## 2.4 출력
> 소개

출력은 필수 구성요소로, 파이프라인의 입력과 필터를 거쳐 가공된 데이터를 지정한 대상으로 내보내는 단계이다.  